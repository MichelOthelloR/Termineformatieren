<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Termin-Formatierer Pro - GitHub Version</title>
<style>
:root {
  --bg: #0f172a; --card: #111827; --accent: #3b82f6; --text: #e5e7eb; --muted: #9ca3af; --border: #1f2933;
}
* { box-sizing: border-box; font-family: 'Inter', sans-serif; }
body { background: var(--bg); color: var(--text); padding: 40px; display: flex; justify-content: center; }
.app { width: 100%; max-width: 1000px; background: var(--card); border-radius: 16px; padding: 28px; border: 1px solid var(--border); }
.header-area { margin-bottom: 20px; }
h1 { font-size: 22px; margin: 0 0 4px 0; }
.grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
textarea { background: #020617; color: var(--text); border: 1px solid var(--border); border-radius: 10px; padding: 14px; min-height: 450px; width: 100%; font-size: 13px; line-height: 1.6; resize: vertical; outline: none; }
textarea:focus { border-color: var(--accent); }
.debug-area { margin-top: 30px; padding-top: 20px; border-top: 1px dashed var(--border); }
#debug-output { background: #000; color: #a5f3fc; font-family: monospace; font-size: 12px; white-space: pre-wrap; padding: 15px; border-radius: 10px; max-height: 150px; overflow-y: auto; }
button { background: var(--accent); border: none; color: white; padding: 12px 24px; border-radius: 10px; cursor: pointer; font-weight: 600; margin-top: 20px; }
.status { font-size: 13px; margin-left: 15px; }
label { font-size: 13px; margin-bottom: 8px; color: var(--muted); font-weight: 600; display: block; }
</style>
</head>
<body>

<div class="app">
  <div class="header-area">
    <h1>Terminübersicht aufbereiten</h1>
    <p style="color:var(--muted)">Chronologische Sortierung | Einmalige Zusatztexte</p>
  </div>

  <div class="grid">
    <div class="box"><label>Eingabe (Excel-Daten)</label><textarea id="input"></textarea></div>
    <div class="box"><label>Ergebnis (automatisch kopiert)</label><textarea id="output" readonly></textarea></div>
  </div>

  <button onclick="formatText()">Formatieren</button>
  <span id="status" class="status"></span>

  <div class="debug-area">
    <label>Verfügbare Beschreibungen (daten.js):</label>
    <div id="debug-output">Lade daten.js...</div>
  </div>
</div>

<script type="module">
  // Import der Datenbank
  import { BESCHREIBUNGEN_DB } from './daten.js';

  // Debug-Anzeige beim Start
  const debugOut = document.getElementById('debug-output');
  if (typeof BESCHREIBUNGEN_DB !== 'undefined') {
      debugOut.textContent = JSON.stringify(BESCHREIBUNGEN_DB, null, 4);
  }

  function getISOWeekData(date) {
    const tempDate = new Date(date.valueOf());
    tempDate.setHours(0, 0, 0, 0);
    tempDate.setDate(tempDate.getDate() + 4 - (tempDate.getDay() || 7));
    const year = tempDate.getFullYear();
    const yearStart = new Date(year, 0, 1);
    const week = Math.ceil((((tempDate - yearStart) / 86400000) + 1) / 7);
    return { year, week };
  }

  function parseGermanDate(dateStr) {
    if (!dateStr) return null;
    const parts = dateStr.trim().split('.');
    if (parts.length === 3) {
      let year = parts[2].trim();
      if (year.length === 2) year = "20" + year;
      return new Date(year, parts[1] - 1, parts[0]);
    }
    return null;
  }

  window.formatText = async function() {
    const input = document.getElementById("input").value.trim();
    if (!input) return;

    const rows = input.split(/\r?\n/);
    const groups = {};
    
    // Set zur Nachverfolgung bereits verwendeter Beschreibungen
    const usedDescriptions = new Set();

    rows.forEach(row => {
      const cols = row.split("\t");
      if (cols.length < 5) return;

      const dateObj = parseGermanDate(cols[0]);
      let subject = cols[4].trim().replace(/^[\d./-]+\s*/, "");

      if (dateObj && !isNaN(dateObj)) {
        const { year, week } = getISOWeekData(dateObj);
        const groupKey = `${year}-${week.toString().padStart(2, '0')}`;
        if (!groups[groupKey]) groups[groupKey] = { week, entries: [] };
        groups[groupKey].entries.push({ date: dateObj, text: subject });
      }
    });

    const sortedKeys = Object.keys(groups).sort();

    const result = sortedKeys.map(key => {
      const g = groups[key];
      const lines = g.entries.sort((a,b) => a.date - b.date).map(e => {
        let line = "• " + e.text;
        const cleanSubject = e.text.trim();

        // Logik: Nur ergänzen, wenn in daten.js vorhanden UND noch nicht zuvor verwendet
        if (BESCHREIBUNGEN_DB[cleanSubject] && !usedDescriptions.has(cleanSubject)) {
          line += "\n  " + BESCHREIBUNGEN_DB[cleanSubject];
          usedDescriptions.add(cleanSubject); // Als verwendet markieren
        }
        
        return line;
      }).join("\n");
      return `KW ${g.week}\n${lines}`;
    }).join("\n\n");

    document.getElementById("output").value = result;
    
    try {
      await navigator.clipboard.writeText(result);
      const status = document.getElementById("status");
      status.textContent = "✔ Kopiert";
      status.style.color = "#22c55e";
      setTimeout(() => status.textContent = "", 2000);
    } catch (err) {
      console.error("Copy failed", err);
    }
  };

  document.getElementById("input").addEventListener("input", window.formatText);
</script>

</body>
</html>
