<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Termin-Formatierer Pro - GitHub Version</title>
<style>
:root {
  --bg: #0f172a; --card: #111827; --accent: #3b82f6; --text: #e5e7eb; --muted: #9ca3af; --border: #1f2933;
}
* { box-sizing: border-box; font-family: 'Inter', sans-serif; }
body { background: var(--bg); color: var(--text); padding: 40px; display: flex; justify-content: center; }
.app { width: 100%; max-width: 1000px; background: var(--card); border-radius: 16px; padding: 28px; border: 1px solid var(--border); }
.header-area { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; }
.logo { width: 130px; height: 130px; object-fit: contain; }
.grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
textarea { background: #020617; color: var(--text); border: 1px solid var(--border); border-radius: 10px; padding: 14px; min-height: 400px; width: 100%; font-size: 13px; line-height: 1.6; }
.debug-area { margin-top: 30px; padding-top: 20px; border-top: 1px dashed var(--border); }
#debug-output { background: #000; color: #a5f3fc; font-family: monospace; font-size: 12px; white-space: pre-wrap; padding: 15px; border-radius: 10px; max-height: 200px; overflow-y: auto; }
button { background: var(--accent); border: none; color: white; padding: 12px 24px; border-radius: 10px; cursor: pointer; font-weight: 600; margin-top: 20px; }
.status { font-size: 13px; margin-left: 15px; }
</style>
</head>
<body>

<div class="app">
  <div class="header-area">
    <div>
      <h1>Terminübersicht aufbereiten</h1>
      <p style="color:var(--muted)">GitHub Modul-Version (Chronologisch + Beschreibungen)</p>
    </div>
    <img src="icon_website.png" alt="Logo" class="logo">
  </div>

  <div class="grid">
    <div class="box"><label>Eingabe</label><textarea id="input"></textarea></div>
    <div class="box"><label>Ergebnis</label><textarea id="output" readonly></textarea></div>
  </div>

  <button onclick="formatText()">Formatieren</button>
  <span id="status" class="status"></span>

  <div class="debug-area">
    <label>Geladene Datenbank:</label>
    <div id="debug-output">Lade daten.js...</div>
  </div>
</div>

<script type="module">
  // Import der Datenbank vom selben Pfad
  import { BESCHREIBUNGEN_DB } from './daten.js';

  // Debug-Anzeige beim Start
  const debugOut = document.getElementById('debug-output');
  debugOut.textContent = JSON.stringify(BESCHREIBUNGEN_DB, null, 4);

  // Hilfsfunktionen
  function getISOWeekData(date) {
    const tempDate = new Date(date.valueOf());
    tempDate.setHours(0, 0, 0, 0);
    tempDate.setDate(tempDate.getDate() + 4 - (tempDate.getDay() || 7));
    const year = tempDate.getFullYear();
    const yearStart = new Date(year, 0, 1);
    const week = Math.ceil((((tempDate - yearStart) / 86400000) + 1) / 7);
    return { year, week };
  }

  function parseGermanDate(dateStr) {
    const parts = dateStr.trim().split('.');
    if (parts.length === 3) {
      let year = parts[2].trim();
      if (year.length === 2) year = "20" + year;
      return new Date(year, parts[1] - 1, parts[0]);
    }
    return null;
  }

  // Die Hauptfunktion wird an 'window' gebunden, damit der HTML-Button sie findet
  window.formatText = async function() {
    const input = document.getElementById("input").value.trim();
    if (!input) return;

    const rows = input.split(/\r?\n/);
    const groups = {};

    rows.forEach(row => {
      const cols = row.split("\t");
      if (cols.length < 5) return;

      const dateObj = parseGermanDate(cols[0]);
      let subject = cols[4].trim().replace(/^[\d./-]+\s*/, "");

      if (dateObj && !isNaN(dateObj)) {
        const { year, week } = getISOWeekData(dateObj);
        const groupKey = `${year}-${week.toString().padStart(2, '0')}`;
        if (!groups[groupKey]) groups[groupKey] = { week, entries: [] };
        groups[groupKey].entries.push({ date: dateObj, text: subject });
      }
    });

    const result = Object.keys(groups).sort().map(key => {
      const g = groups[key];
      const lines = g.entries.sort((a,b) => a.date - b.date).map(e => {
        let line = "• " + e.text;
        if (BESCHREIBUNGEN_DB[e.text.trim()]) line += "\n  " + BESCHREIBUNGEN_DB[e.text.trim()];
        return line;
      }).join("\n");
      return `KW ${g.week}\n${lines}`;
    }).join("\n\n");

    document.getElementById("output").value = result;
    await navigator.clipboard.writeText(result);
    document.getElementById("status").textContent = "✔ Kopiert";
    setTimeout(() => document.getElementById("status").textContent = "", 2000);
  };

  // Event Listener für Live-Update
  document.getElementById("input").addEventListener("input", window.formatText);
</script>

</body>
</html>
