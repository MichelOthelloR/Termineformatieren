<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Termin-Formatierer Pro - Management Edition</title>
<style>
:root {
  --bg: #0f172a; --card: #111827; --accent: #3b82f6; --text: #e5e7eb; --muted: #9ca3af; --border: #1f2933; --warning: #f59e0b;
}
* { box-sizing: border-box; font-family: 'Inter', sans-serif; }
body { background: var(--bg); color: var(--text); padding: 40px; display: flex; justify-content: center; }
.app { width: 100%; max-width: 1000px; background: var(--card); border-radius: 16px; padding: 28px; border: 1px solid var(--border); }
.header-area { margin-bottom: 20px; }
h1 { font-size: 22px; margin: 0 0 4px 0; }
.grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
textarea { background: #020617; color: var(--text); border: 1px solid var(--border); border-radius: 10px; padding: 14px; min-height: 400px; width: 100%; font-size: 13px; line-height: 1.6; resize: vertical; outline: none; }
textarea:focus { border-color: var(--accent); }

/* Missing Entries Area */
.missing-area { margin-top: 30px; padding: 20px; border: 1px solid var(--warning); border-radius: 12px; display: none; background: rgba(245, 158, 11, 0.05); }
.missing-item { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
.missing-item input { background: #1e293b; border: 1px solid var(--border); color: white; padding: 8px; border-radius: 6px; flex-grow: 1; }

.export-area { margin-top: 20px; display: none; }
#export-code { background: #000; color: #34d399; font-family: monospace; font-size: 11px; padding: 15px; border-radius: 10px; overflow-x: auto; }

button { background: var(--accent); border: none; color: white; padding: 12px 24px; border-radius: 10px; cursor: pointer; font-weight: 600; margin-top: 20px; }
.btn-save { background: #22c55e; margin-top: 10px; }
label { font-size: 13px; margin-bottom: 8px; color: var(--muted); font-weight: 600; display: block; }
</style>
</head>
<body>

<div class="app">
  <div class="header-area">
    <h1>Terminübersicht aufbereiten</h1>
    <p style="color:var(--muted)">Inklusive Erkennung fehlender Beschreibungen</p>
  </div>

  <div class="grid">
    <div class="box"><label>Eingabe</label><textarea id="input"></textarea></div>
    <div class="box"><label>Ergebnis</label><textarea id="output" readonly></textarea></div>
  </div>

  <button onclick="formatText()">Formatieren & Prüfen</button>

  <div id="missing-box" class="missing-area">
    <h3 style="color:var(--warning); margin-top:0;">⚠️ Fehlende Beschreibungen gefunden</h3>
    <p style="font-size:12px;">Bitte ergänze die Zusätze. Klicke dann auf "In Datenbank übernehmen", um den neuen Code für deine daten.js zu erhalten.</p>
    <div id="missing-list"></div>
    <button class="btn-save" onclick="updateDatabase()">In Datenbank übernehmen</button>
  </div>

  <div id="export-box" class="export-area">
    <label>Kopiere diesen Text in deine <b>daten.js</b> auf GitHub:</label>
    <pre id="export-code"></pre>
  </div>
</div>

<script>
  // ERSETZE DIESE URL durch deinen "Im Web veröffentlichen" CSV-Link von Google Sheets!
  const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR_DEIN_VERÖFFENTLICHUNGS_ID/pub?output=csv';

  let db = {};

  // Funktion zum Laden der Google Sheets Daten
  async function loadDatabase() {
    try {
      const response = await fetch(SHEET_CSV_URL);
      const data = await response.text();
      const rows = data.split('\n').slice(1); // Erste Zeile (Header) überspringen
      
      rows.forEach(row => {
        const columns = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/); // Trennung am Komma, ignoriert Kommas in Anführungszeichen
        if (columns.length >= 2) {
          const key = columns[0].replace(/"/g, '').trim();
          const value = columns[1].replace(/"/g, '').trim();
          db[key] = value;
        }
      });
      document.getElementById('db-status').textContent = "✔ Datenbank aktuell (Google Sheets)";
    } catch (e) {
      console.error("Fehler beim Laden der Google Daten", e);
      document.getElementById('db-status').textContent = "✖ Fehler beim Laden der Google Daten";
    }
  }

  // Initiales Laden
  loadDatabase();

  // Deine Formatierungs-Logik (angepasst auf die neue DB)
  window.formatText = async function() {
    const input = document.getElementById("input").value.trim();
    if (!input) return;

    const rows = input.split(/\r?\n/);
    const groups = {};
    const usedDescriptions = new Set();

    rows.forEach(row => {
      const cols = row.split("\t");
      if (cols.length < 5) return;
      const dateParts = cols[0].split('.');
      const dateObj = new Date(dateParts[2], dateParts[1]-1, dateParts[0]);
      let subject = cols[4].trim().replace(/^[\d./-]+\s*/, "");

      if (dateObj && !isNaN(dateObj)) {
        // ... (Wochenberechnung wie zuvor)
        const year = dateObj.getFullYear();
        // Einfache KW Berechnung zur Demo
        const week = Math.ceil((((dateObj - new Date(year, 0, 1)) / 86400000) + 1) / 7);
        const groupKey = `${year}-${week.toString().padStart(2, '0')}`;
        
        if (!groups[groupKey]) groups[groupKey] = { week, entries: [] };
        groups[groupKey].entries.push({ date: dateObj, text: subject });
      }
    });

    const result = Object.keys(groups).sort().map(key => {
      const g = groups[key];
      const lines = g.entries.sort((a,b) => a.date - b.date).map(e => {
        let line = "• " + e.text;
        if (db[e.text] && !usedDescriptions.has(e.text)) {
          line += "\n  " + db[e.text];
          usedDescriptions.add(e.text);
        }
        return line;
      }).join("\n");
      return `KW ${g.week}\n${lines}`;
    }).join("\n\n");

    document.getElementById("output").value = result;
    await navigator.clipboard.writeText(result);
  };
</script>

</body>
</html>

